---
interface Props {
  currentLang: 'ja' | 'en';
  currentSlug?: string;
  hasTranslation?: boolean;
}

const { currentLang = 'ja', currentSlug = '', hasTranslation = false } = Astro.props;

// 言語切り替えURL生成
const jaUrl = currentSlug ? `/blog/${currentSlug}/` : '/blog/';
const enUrl = currentSlug ? `/blog/en/${currentSlug}/` : '/blog/en/';
---

<div class="blog-toggle-bar" id="blog-toggle-bar">
  <!-- ダークモードトグル -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
    <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 0 0 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 0 0 0-1.41.996.996 0 0 0-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 0 0 0-1.41.996.996 0 0 0-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
    </svg>
    <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
    </svg>
  </button>

  <!-- 言語切り替え -->
  <div class="lang-switch">
    <a
      href={jaUrl}
      class:list={[{ active: currentLang === 'ja' }]}
      aria-current={currentLang === 'ja' ? 'page' : undefined}
    >
      JP
    </a>
    <span>/</span>
    {hasTranslation || !currentSlug ? (
      <a
        href={enUrl}
        class:list={[{ active: currentLang === 'en' }]}
        aria-current={currentLang === 'en' ? 'page' : undefined}
      >
        EN
      </a>
    ) : (
      <span class="lang-disabled" title="English version not available">EN</span>
    )}
  </div>
</div>

<style>
  .lang-disabled {
    padding: 0.375rem 0.75rem;
    color: var(--blog-border);
    cursor: not-allowed;
  }
</style>

<script is:inline>
  // フラッシュ防止: ページ読み込み時に即座にテーマを適用
  (function() {
    const theme = localStorage.getItem('blog-theme') || 'light';
    document.documentElement.dataset.theme = theme;
  })();
</script>

<script>
  // テーマトグルの機能
  function initThemeToggle() {
    const toggle = document.getElementById('theme-toggle');
    if (!toggle) return;

    toggle.addEventListener('click', () => {
      const html = document.documentElement;
      const currentTheme = html.dataset.theme || 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      html.dataset.theme = newTheme;
      localStorage.setItem('blog-theme', newTheme);

      // Giscusテーマも更新
      updateGiscusTheme(newTheme);
    });
  }

  // Giscusのテーマを動的に変更
  function updateGiscusTheme(theme: string) {
    const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
    if (iframe && iframe.contentWindow) {
      iframe.contentWindow.postMessage(
        {
          giscus: {
            setConfig: {
              theme: theme === 'dark' ? 'dark' : 'light'
            }
          }
        },
        'https://giscus.app'
      );
    }
  }

  // ページ読み込み時に初期化
  document.addEventListener('DOMContentLoaded', initThemeToggle);
  // View Transitions対応
  document.addEventListener('astro:page-load', initThemeToggle);
</script>
